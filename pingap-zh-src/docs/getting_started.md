---
sidebar_position: 11
---

# 入门教程

欢迎使用 Pingap！本教程将引导您从零开始，一步步搭建、配置并运行一个功能完备的高性能反向代理服务。我们将从最简单的启动开始，通过 Web 管理后台完成所有核心配置，最终以守护进程模式稳定运行。


## 准备工作

在开始之前，请确保您已经下载并安装了`pingap`的二进制可执行文件。

本教程将使用文件系统来存储所有配置信息，这对于大多数场景来说都是最简单直接的方式。我们将所有配置文件存放在`/opt/pingap/conf`目录下。

```bash
# 创建配置目录
mkdir -p /opt/pingap/conf
```

## 第一步：首次启动与 Web 管理后台

对于初学者而言，最快上手的方式就是启动 pingap 并开启其内置的 Web 管理后台。这可以让我们在图形化界面中完成所有配置。

执行以下命令来首次启动`pingap`：

```bash
# -c 指定配置目录
# --admin 启用Web管理后台，格式为: <user>:<password>@<listen_addr>
RUST_LOG=INFO pingap -c /opt/pingap/conf --admin=pingap:YourSecurePassword@127.0.0.1:3018
```

命令解析:

- `RUST_LOG=INFO`: 设置日志级别为`INFO`，便于观察程序运行状态，如果需要输出更多日志，可以设置为`DEBUG`
- `-c /opt/pingap/conf`: 指定配置文件的存储目录。`pingap`会自动在此目录下读写`*.toml`配置文件。
- `--admin=pingap:YourSecurePassword@127.0.0.1:3018`: 启用管理后台。
   - `账号`: pingap
   - `密码`: YourSecurePassword (请务必替换为您自己的强密码!)
   - `监听地址`: `127.0.0.1:3018`，表示仅在本地监听 3018 端口，服务器可以设置为`0.0.0.0:3018`或服务器的IP

🔒 安全提示
为了防止暴力破解，管理后台内置了登录保护机制：同一 IP 多次输错密码将被临时锁定 5 分钟。

现在，打开浏览器访问`http://127.0.0.1:3018`，您将看到登录界面。输入刚才设置的账号密码，即可进入管理后台。

## 第二步：理解核心配置流程

在`pingap`中，一个完整的代理服务由三个核心概念组成，它们之间存在依赖关系：

1. 上游 (Upstream): 定义了后端真实服务的地址和属性（如健康检查、超时等）。
2. 路由 (Location): 定义了请求的匹配规则（如域名、路径）以及将请求转发到哪个上游。
3. 服务 (Server): 定义了 `pingap` 监听的端口和协议，并绑定一组 `路由` 规则。

因此，我们的配置顺序应该是：先创建上游 → 再创建路由 → 最后创建服务。

## 第三步：通过 Web UI 完成代理配置

接下来，我们将通过 Web 界面，完成一个将`http://<your-domain>/app/`的请求代理到后端服务`http://127.0.0.1:8080/`的经典配置。

1. 添加上游 (Upstream)

上游是所有配置的基础。

- 在左侧菜单栏点击 “上游服务器配置”，默认为新增，如果要修改则选择对应的`Upstream`。
- 名称: 填写一个有意义的名称，例如`my-app-service`。
- 地址: 填写后端服务的实际地址，例如`127.0.0.1:8080`，对于权重一般不需要设置，如果有多个节点则配置多个即可。若上游为HTTPS协议的节点需要配置SNI。

💡 最佳实践：强烈建议您展开“高级配置”面板进行设置

超时设置: 根据您的应用特性，为连接、读取和写入设置合理的超时时间，避免因后端服务无响应而拖垮代理。

健康检查: 设置一个健康检查端点（如`http://host/ping`），`pingap`会自动剔除不健康的后端节点，提升服务可用性，其中`host`部分要检测时会自动替换为`ip:port`形式，若不设置默认为通过tcp端口的形式检测。


2. 添加路由 (Location)

路由负责将满足条件的请求转发给指定的上游。

- 在左侧菜单栏点击 “Location配置”，默认为新增，如果要修改则选择对应的`Location`。
- 名称: 填写一个有意义的名称，例如`route-for-my-app`。
- 上游: 在下拉框中选择我们刚刚创建的`my-app-service`。
- 域名(Host): 填写您希望对外提供服务的域名，例如`app.example.com`，如果只使用`Path`即可匹配则不需要填写。
- 路径(Path): 填写匹配的路径规则，例如`/app`。

💡 最佳实践：启用反向代理请求头

若`Pingap`为接入节点，建议勾选`启用反向代理请求头`。这会自动添加`X-Forwarded-For, X-Forwarded-Proto`等标准代理请求头，方便后端应用获取真实的客户端信息。

❗ 注意事项：如果您的上游服务（Upstream）本身也是一个反向代理（如 Nginx），并且它依赖`Host`作为路由转发，请务必在“设置转发请求头”中，将`Host`设置为上游服务期望的值。


3. 配置服务 (Server)

服务是代理的入口，它监听指定端口并将请求交给路由处理。

- 在左侧菜单栏点击 “服务配置”，默认为新增，如果要修改则选择对应的`Server`。
- 名称: 填写一个有意义的名称，例如`main-http-server`。
- 监听地址: 填写 pingap 对外服务的地址和端口，例如`0.0.0.0:6188`(监听所有网络接口的 6188 端口)。
- Locations: 在下拉框中勾选我们刚刚创建的`route-for-my-app`，如果选择多个location，会根据各location的权重匹配。

💡 最佳实践：配置访问日志，为了方便排查问题，建议配置访问日志。在“访问日志格式”中选择一个预设模板（如 common 或 combined），或根据需要自定义格式。

至此，所有的基础配置都已完成！这些配置已经自动保存到了`/opt/pingap/conf`目录下的`.toml`文件中。


## 第四步：后台运行与自动更新

现在，我们希望`pingap`能像一个真正的服务一样在后台运行，并且在配置变更后能自动应用新配置。

首先，按 Ctrl+C 停止当前在前台运行的`pingap`进程。

然后，使用以下这条更完整的命令来启动它：

```bash
RUST_LOG=INFO pingap -c /opt/pingap/conf \
  -d \
  --log=/opt/pingap/pingap.log \
  --autoreload \
  --admin=pingap:YourSecurePassword@127.0.0.1:3018
```

新增参数解析:

- `-d`: Daemonize，让程序以守护进程（后台）模式运行。
- `--log=/opt/pingap/pingap.log`: 将日志输出到指定文件，而不是终端。
- `--autoreload`: 热更新模式（生产推荐）。`pingap`会定期（约10秒）检测配置文件的变化。当`Upstream`, `Location`, `Plugin` 以及 `Certificate`等配置发生变化时，它会无需重启、不中断服务地应用新配置。

何时使用 --autorestart?

`--autorestart`是一种重启更新模式。它用于变更更底层的配置，如Server的监听端口等。这种模式会自动使用`upgrade`的方式让旧实例的请求转给新实例，但是如果调整监听端口等会导致旧的端口不会关闭等现象。建议仅在测试环境或需要频繁变更基础配置时使用。生产环境中，对于基础配置的变更(例如监听服务监听端口等较少变更），建议手动执行平滑重启（upgrade）。


## 第五步：验证配置

现在，`pingap`已经在后台稳定运行。让我们来验证一下配置是否生效。

1、访问服务:

打开浏览器或使用 curl 访问`http://<pingap-server-ip>:6188/app/some/path`。如果一切正常，请求应该会被成功转发到后端的`http://127.0.0.1:8080/app/some/path`。

2、测试热更新:

登录 Web 管理后台`http://127.0.0.1:3018`。

进入 “Location” 管理页面，将`route-for-my-app`的路径从`/app`修改为`/pingap-app`并保存。

稍等片刻（约10秒），观察后台日志文件`tail -f /opt/pingap/pingap.log-YYYY-MM-DD`，您应该能看到类似`reload location success`的日志。

此时，再次访问`http://<pingap-server-ip>:6188/app/`会失败，而访问`http://<pingap-server-ip>:6188/pingap-app/`则会成功。

这证明了 pingap 的动态热更新能力已经生效，您可以在不中断服务的情况下随时调整路由和上游策略。

