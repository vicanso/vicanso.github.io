---
sidebar_position: 81
---

# 常见问题 (FAQ)

这里汇集了用户在使用 `Pingap` 过程中最常遇到的一些问题及其解决方案。

Q: 我有多个服务使用同一个端口，为什么通过域名访问时路由不正确？

A: 这是因为当多个服务共用一个 IP 和端口时，`Pingap` 需要依赖请求头中的 Host 字段来区分并将请求转发到正确的后端。默认情况下，`Pingap` 会将客户端原始请求的 Host 头直接透传给后端。

解决方案：如果您的上游服务 (Upstream) 本身也需要根据 Host 头来处理请求，您必须在 Location 配置 的 转发请求头 (proxy_set_headers) 选项中，将 Host 显式设置为您后端服务期望的域名。


Q: 我更新了域名的 `DNS` 解析，为什么 `Pingap` 没有转发到新的 `IP` 地址？

A: `Pingap` 默认的服务发现机制，在处理配置为域名的 `Upstream` 地址时，只会在启动时进行一次 `DNS` 解析。如果解析到多个 `IP`，它们都会被作为节点添加，但之后 `DNS` 记录的任何变化都无法被自动感知。

解决方案：如果您的上游服务 `IP` 地址是动态变化的（例如在云环境或 Kubernetes 中），您应该为该 `Upstream` 配置 `DNS` 服务发现。具体方法是在 `Upstream` 配置中添加 `discovery = "dns"` 并设置一个合理的 `update_frequency`（如 30s）。


Q: 如何为 `Pingap` 配置线程数？它的工作机制是怎样的？

A: `Pingap` 的工作线程数可以进行精细化控制，其配置优先级如下：

1. Server 级配置：在 `server.toml` 中为特定服务设置的 `threads` 值，优先级最高。
2. 全局基础配置：在 `basic.toml` 中设置的 `threads` 值，作为所有未单独配置线程数的 `Server` 的默认值。
3. 程序默认值：如果以上两项均未配置，则默认为 `1` 个线程。

此外，将 `threads` 设置为 `0` 是一种特殊模式，它会告诉 `Pingap` 自动将线程数设置为与当前环境的 `CPU` 核心数相等。


Q: 当我的后端服务 (Upstream) 使用 HTTPS 协议时，需要注意什么？

A: 当您配置一个使用 HTTPS 的 `Upstream` 时，请确保完成以下两项关键配置：

1. 设置 SNI：必须在 `Upstream` 配置中正确填写 `sni` 字段，其值通常是您后端服务的域名。这是 TLS 握手成功的关键。
2. 端口：如果您的后端服务使用的是标准的 `443` 端口，您可以省略端口号；否则，请务必在 `addrs` 中明确指定端口。


Q: 如何在同一个端口上为多个不同的域名提供 HTTPS 服务？

A: `Pingap` 完全支持基于 SNI 的多域名 HTTPS 服务，配置非常简单：

1. 添加所有证书：在 证书管理 界面，为您需要支持的所有域名上传或申请对应的 HTTPS 证书。
2. 开启全局证书：在 `server.toml` 配置文件中，找到您提供 HTTPS 服务的那个 `Server`，并确保勾选了 `启用全局证书配置 (global_certificates)` 选项。

完成这两步后，Pingap 会在处理 TLS 连接时，根据客户端请求的域名自动选择并提供正确的证书。


Q: 我的服务部署在多个 IP 上，如何避免所有实例都去申请 Let's Encrypt 证书？

A: 这是一个非常典型的多节点部署场景。当一个域名解析到多个 IP 地址（对应多个 `Pingap` 实例）时，您必须只让其中一个实例负责 ACME 证书的申请和续期。如果所有实例都去申请，会很快触发 Let's Encrypt 的速率限制，并可能因验证冲突导致申请失败。

解决方案：在除了主实例之外的所有其他 `Pingap` 实例上，通过设置环境变量来禁用 `ACME` 功能。

```bash
PINGAP_DISABLE_ACME=true
```
这样，只有主实例会处理证书事宜，其他实例则会等待并共享主实例申请到的证书（通常通过共享存储或配置中心实现）。

