---
sidebar_position: 89
title: IP 限制 (IP Restriction)
description: 通过配置 IP 地址的黑名单或白名单，实现对特定来源的访问控制，有效阻止恶意访问、限制服务访问范围，增强应用安全性。
---

# IP 限制 (IP Restriction) 插件

`ip-restriction` 插件是一个请求阶段的安全插件，它允许您根据客户端的 IP 地址来**允许**或**拒绝**访问请求，是实现网络访问控制 (ACL) 的一道重要防线。

## 功能简介

该插件会在请求到达上游服务之前，检查请求的来源 IP 地址。它支持两种核心工作模式：

1.  **黑名单 (Deny)**: 拒绝列表中指定的 IP 地址或 IP 段的访问，允许其他所有 IP 访问。
2.  **白名单 (Allow)**: 只允许列表中指定的 IP 地址或 IP 段的访问，拒绝其他所有 IP。

插件能够智能地识别客户端的真实 IP (优先从 `X-Forwarded-For` 等代理头中获取)，并支持配置单个 IP 地址和 CIDR 网段，提供了灵活而强大的访问控制能力。

## 使用场景

* **屏蔽恶意访问**：发现有恶意 IP 地址正在对您的服务进行扫描或攻击时，可以快速将其加入**黑名单**，立即阻止其所有请求。
* **保护内部系统**：对于管理后台、数据库面板等高权限系统，可以配置一个**白名单**，只允许来自公司内部网络或特定堡垒机的 IP 地址访问。
* **实现地理区域限制**：通过将特定国家或地区的 IP 段加入黑名单或白名单，实现简单的地理位置访问控制。
* **API 访问授权**：为合作伙伴或特定的服务器开放 API 访问权限，将其 IP 地址配置在**白名单**中。

## 配置参数

在 `plugin.ip-restriction.toml` 文件中进行配置。

| 参数      | 类型             | 是否必需 | 默认值                   | 说明                                                                                                    |
| :-------- | :--------------- | :------- | :----------------------- | :------------------------------------------------------------------------------------------------------ |
| `type`    | String           | **是**   | -                        | **（必需）** 限制类型。可选值为 `"deny"` (黑名单模式) 或 `"allow"` (白名单模式)。                       |
| `ip_list` | Array of Strings | **是**   | `[]`                     | **（必需）** IP 地址列表。支持单个 IP (如 `"192.168.1.10"`) 和 CIDR 网段 (如 `"10.0.0.0/8"`) 两种格式。 |
| `message` | String           | 否       | `"Request is forbidden"` | 当请求被拒绝时，返回给客户端的自定义提示信息。                                                          |

---

## 完整示例

### 示例 1：使用黑名单屏蔽恶意 IP

**目标**：我们发现 `1.2.3.4` 这个 IP 和 `5.6.7.0/24` 这个网段的用户正在对我们的网站进行恶意扫描，需要将他们屏蔽。

1.  **配置插件 (`plugin.ip-blacklist.toml`)**:
    ```toml
    # 设置为黑名单模式
    type = "deny"
    
    # 列出要屏蔽的 IP 和网段
    ip_list = [
      "1.2.3.4",
      "5.6.7.0/24",
    ]

    # 可选：提供更友好的提示信息
    message = "Your IP address has been blocked due to suspicious activity."
    ```

2.  **在 Location 中应用插件 (`location.toml`)**:
    ```toml
    # ...
    [locations.route-for-my-app]
    # 匹配所有请求
    path = "/"
    upstream = "my-web-server"
    plugins = [
        # 将黑名单插件放在最前面，尽早拦截恶意请求
        "ip-blacklist",
        # ... 其他插件
    ]
    # ...
    ```

### 访问效果

* 来自 `1.2.3.4` 或 `5.6.7.100` 的任何请求都会被立即拦截，并收到一个 `403 Forbidden` 响应，响应体为我们自定义的 `message`。
* 来自任何其他 IP 地址（如 `8.8.8.8`）的请求将不受影响，正常转发到 `my-web-server`。

### 示例 2：使用白名单保护管理后台

**目标**：我们的管理后台只能从办公室网络 (`10.20.0.0/16`) 和一个特定的运维堡垒机 (`172.16.3.100`) 访问。

1.  **配置插件 (`plugin.ip-whitelist-admin.toml`)**:
    ```toml
    # 设置为白名单模式
    type = "allow"
    
    # 列出允许访问的 IP 和网段
    ip_list = [
      "10.20.0.0/16",
      "172.16.3.100",
    ]
    ```

2.  **在 Location 中应用插件 (`location.toml`)**:
    ```toml
    # ...
    [locations.route-for-my-app]
    # 只对管理后台的路径生效
    path = "/admin/"
    upstream = "admin-backend"
    plugins = [
        "ip-whitelist-admin",
        # ... 其他认证插件
    ]
    # ...
    ```

### 访问效果
* 来自 `10.20.30.40` 或 `172.16.3.100` 的请求可以正常访问 `/admin/` 路径。
* 来自任何其他 IP 地址（如 `8.8.8.8`）的请求在访问 `/admin/` 时，将被拦截并收到 `403 Forbidden` 响应。