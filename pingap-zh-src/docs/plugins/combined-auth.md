---
sidebar_position: 84
title: 组合认证 (Combined Auth)
description: 一种专为服务间调用设计的、安全可靠的签名认证方案。通过组合 App ID, IP 白名单, 时间戳和 HMAC 摘要，为您的内部 API 提供多层级的安全防护。
---

# 组合认证 (Combined Auth) 插件

`combined-auth` 插件提供了一种强大的、基于 **HMAC 签名**的认证机制，专为需要高安全性的**服务间调用 (machine-to-machine)** 场景而设计。

## 功能简介

与简单的 API Key 认证不同，组合认证要求调用方提供多个维度的信息，并通过加密摘要来确保请求的真实性、完整性和时效性。

当启用此插件后，每一个请求都必须在 URL 查询参数中携带以下字段，并通过多层校验：
1.  **`app_id` (应用 ID)**：识别是哪个应用在发起调用。插件会根据 `app_id` 查找对应的认证配置。
2.  **IP 白名单校验 (可选)**：检查请求的来源 IP 是否在为该 `app_id` 配置的允许列表中。
3.  **`ts` (时间戳)**：请求发起时的 Unix 时间戳。插件会校验此时间戳与服务器当前时间的偏差是否在允许范围内，有效**防止重放攻击**。
4.  **`digest` (摘要)**：一个基于**密钥**和**时间戳**生成的 HMAC-SHA256 摘要。这是验证的核心，由于密钥仅客户端和服务器持有，因此它可以证明请求确实来自合法的客户端，并且时间戳等信息未被篡改。

只有当所有校验全部通过时，请求才会被允许访问上游服务。

## 使用场景

* **保护内部核心 API**: 对于涉及支付、用户数据修改等核心功能的内部微服务，使用组合认证可以确保只有经过授权的、合法的内部服务才能调用。
* **开放平台 API**: 为您的合作伙伴或第三方开发者提供 API 时，可以为每个开发者分配一个 `app_id` 和 `secret`，通过此插件进行安全、隔离的认证。
* **取代复杂的 OAuth 流程**: 对于纯粹的服务端到服务端的调用，组合认证比 OAuth 2.0 等流程更轻量、更易于实现。

## 配置参数

在 `plugin.combined-auth.toml` 文件中进行配置。

| 参数             | 类型            | 是否必需 | 说明                              |
| :--------------- | :-------------- | :------- | :-------------------------------- |
| `authorizations` | Array of Tables | **是**   | **（必需）** 授权应用的配置列表。 |

### `authorizations` 列表内每个对象的参数

| 参数        | 类型             | 是否必需 | 默认值 | 说明                                                                                                   |
| :---------- | :--------------- | :------- | :----- | :----------------------------------------------------------------------------------------------------- |
| `app_id`    | String           | **是**   | -      | **（必需）** 应用的唯一标识符。                                                                        |
| `secret`    | String           | **是**   | -      | **（必需）** 用于生成 HMAC 摘要的**绝密**密钥。特殊值 `*` 表示超级用户，将跳过所有验证（请谨慎使用）。 |
| `deviation` | Integer          | 否       | `60`   | 允许的客户端时间戳与服务器时间的最大偏差，单位为**秒**。                                               |
| `ip_list`   | Array of Strings | 否       | `[]`   | 一个 IP 白名单，只有来自这些 IP 的请求才被允许。支持单个 IP 和 CIDR 网段。                             |

---

## 完整示例

**目标**：我们有一个内部的 `payment-service`，需要为它创建一个安全的 API 接口，只允许 `order-service` 从其固定的服务器 IP (`10.1.2.3`) 调用。

#### 1. 配置插件 (`plugins.combined-auth-internal.toml`)

```toml
[[authorizations]]
# 应用 ID
app_id = "order-service"

# 为其分配一个安全的密钥
secret = "ORDER_SVC_SECRET_KEY_ VERY_SECURE_!@#"

# 只允许来自该服务固定 IP 的请求
ip_list = [
  "10.1.2.3",
]

# 允许 60 秒的时间偏差
deviation = 60
```