"use strict";(self.webpackChunkpingap=self.webpackChunkpingap||[]).push([[8264],{778:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>a,contentTitle:()=>r,default:()=>o,frontMatter:()=>c,metadata:()=>n,toc:()=>d});const n=JSON.parse('{"id":"plugins/cache","title":"Cache","description":"Dramatically improve the performance of frequently accessed APIs, reduce latency, and effectively lighten the load on backend services by caching responses from upstream services. Supports advanced features like dual-layer memory and file caching, cache eviction, and cache purging.","source":"@site/docs/plugins/cache.md","sourceDirName":"plugins","slug":"/plugins/cache","permalink":"/pingap-en/docs/plugins/cache","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/plugins/cache.md","tags":[],"version":"current","sidebarPosition":84,"frontMatter":{"sidebar_position":84,"title":"Cache","description":"Dramatically improve the performance of frequently accessed APIs, reduce latency, and effectively lighten the load on backend services by caching responses from upstream services. Supports advanced features like dual-layer memory and file caching, cache eviction, and cache purging."},"sidebar":"tutorialSidebar","previous":{"title":"Basic Auth","permalink":"/pingap-en/docs/plugins/basic-auth"},"next":{"title":"Combined Auth","permalink":"/pingap-en/docs/plugins/combined-auth"}}');var s=i(4848),l=i(8453);const c={sidebar_position:84,title:"Cache",description:"Dramatically improve the performance of frequently accessed APIs, reduce latency, and effectively lighten the load on backend services by caching responses from upstream services. Supports advanced features like dual-layer memory and file caching, cache eviction, and cache purging."},r="Cache Plugin",a={},d=[{value:"Feature Introduction",id:"feature-introduction",level:2},{value:"Use Cases",id:"use-cases",level:2},{value:"Configuration Parameters",id:"configuration-parameters",level:2},{value:"Complete Example",id:"complete-example",level:2},{value:"1. Configure the plugin (<code>plugin.cache-articles.toml</code>)",id:"1-configure-the-plugin-plugincache-articlestoml",level:4}];function h(e){const t={code:"code",h1:"h1",h2:"h2",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"cache-plugin",children:"Cache Plugin"})}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"cache"})," plugin is a powerful and highly configurable HTTP caching plugin. It can store responses from upstream services in Pingap, allowing subsequent identical requests to be served directly from the cache without needing to contact the backend service again."]}),"\n",(0,s.jsx)(t.h2,{id:"feature-introduction",children:"Feature Introduction"}),"\n",(0,s.jsx)(t.p,{children:"This plugin implements comprehensive HTTP caching logic and offers several advanced features to meet the demands of complex production environments:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Intelligent Caching Strategy"}),": Adheres to HTTP ",(0,s.jsx)(t.code,{children:"Cache-Control"})," response headers (like ",(0,s.jsx)(t.code,{children:"max-age"}),", ",(0,s.jsx)(t.code,{children:"private"}),", ",(0,s.jsx)(t.code,{children:"no-store"}),") to automatically determine if a response can be cached and for how long."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Multiple Cache Backends"}),": Supports storing cache simultaneously in ",(0,s.jsx)(t.strong,{children:"memory"})," and on the ",(0,s.jsx)(t.strong,{children:"filesystem"}),", balancing access speed with storage capacity."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Cache Eviction"}),": When the memory cache reaches its limit, it uses an LRU (Least Recently Used) algorithm to automatically remove the oldest items. File cache does not require eviction to be enabled."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Cache Purge"}),": Supports ",(0,s.jsx)(t.strong,{children:"proactively clearing"})," specific cache entries by sending a special ",(0,s.jsx)(t.code,{children:"PURGE"})," HTTP request, with access control via an IP whitelist."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Cache Stampede Protection (Lock)"}),': In high-concurrency scenarios, for the first request of a resource, only one request is allowed to go to the origin. Other requests will wait for the result of the first one, effectively preventing the backend from being overwhelmed when a cache item expires (also known as the "thundering herd" or "dogpiling" effect).']}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Vary Cache"}),": For instance, enabling the compression plugin will include ",(0,s.jsx)(t.code,{children:"Accept-Encoding"})," as part of the cache key, allowing different compressed versions of the cache to be stored for the same ",(0,s.jsx)(t.code,{children:"URL"}),", reducing the performance overhead of data compression."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Flexible Control Options"}),": You can override the backend's caching policy through configuration or set rules to bypass caching for certain requests."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"use-cases",children:"Use Cases"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"High-Frequency Read APIs"}),": For APIs that are read frequently but whose content does not change often (e.g., fetching product lists, article details, configuration info), enabling the cache can lead to significant performance gains."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Static and Semi-Static Assets"}),": Although there are dedicated static file serving plugins, the cache plugin is also very effective for assets generated by backend services that do not change often (e.g., dynamically generated CSS, profile pictures)."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Protecting Backend Services"}),": During traffic spikes, the cache can act as a solid barrier, absorbing the vast majority of repetitive read requests and protecting backend databases and services from being overwhelmed."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Reducing External API Call Costs"}),": If your service relies on third-party APIs that charge per call, caching their responses can significantly reduce costs."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"configuration-parameters",children:"Configuration Parameters"}),"\n",(0,s.jsxs)(t.p,{children:["Configuration is done in the ",(0,s.jsx)(t.code,{children:"plugin.cache.toml"})," file."]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Parameter"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Type"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Required"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Description"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"directory"})})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"String"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"No"}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:["Specifies the ",(0,s.jsx)(t.strong,{children:"disk directory"})," for storing cache files. If this is configured, file caching is enabled; otherwise, memory caching is used. ",(0,s.jsx)("br",{}),"Note that if multiple cache plugins are configured for memory caching, they share the same cache, which is initialized by the first plugin that is invoked."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"max_size"})})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"String"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"No"}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:["Specifies the maximum capacity of the ",(0,s.jsx)(t.strong,{children:"memory cache"}),", e.g., ",(0,s.jsx)(t.code,{children:'"128MB"'}),", ",(0,s.jsx)(t.code,{children:'"1GB"'}),"."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.strong,{children:(0,s.jsx)(t.code,{children:"eviction"})})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Boolean"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"No"}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:["Whether to enable the LRU-based ",(0,s.jsx)(t.strong,{children:"cache eviction"})," mechanism. Typically used with ",(0,s.jsx)(t.code,{children:"max_size"}),"."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"max_ttl"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"String"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"No"}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,s.jsx)(t.strong,{children:"Forcibly"})," sets the maximum cache validity period (e.g., ",(0,s.jsx)(t.code,{children:'"1h"'}),", ",(0,s.jsx)(t.code,{children:'"10m"'}),"). This setting will ",(0,s.jsx)(t.strong,{children:"override"})," the ",(0,s.jsx)(t.code,{children:"Cache-Control"})," header from the upstream service's response."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"max_file_size"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"String"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"No"}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:["The maximum size of a single response body that can be cached, e.g., ",(0,s.jsx)(t.code,{children:'"1MB"'}),". Responses larger than this will not be cached."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"check_cache_control"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Boolean"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"No"}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,s.jsx)(t.code,{children:"false"}),". Whether to check the ",(0,s.jsx)(t.code,{children:"Cache-Control"})," header. If ",(0,s.jsx)(t.code,{children:"true"})," and the response has no ",(0,s.jsx)(t.code,{children:"Cache-Control"})," header, it will not be cached."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"namespace"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"String"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"No"}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:["Assigns a namespace to cache items, used to isolate different ",(0,s.jsx)(t.code,{children:"Location"}),"s or types of caches."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"headers"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Array of Strings"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"No"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Specifies a set of request header names whose values will be included in the Cache Key calculation. Used to implement Vary caching."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"lock"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"String"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"No"}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:["Enables ",(0,s.jsx)(t.strong,{children:"cache stampede protection"})," and sets the lock wait timeout. Optional values are ",(0,s.jsx)(t.code,{children:'"1s"'}),", ",(0,s.jsx)(t.code,{children:'"2s"'}),", ",(0,s.jsx)(t.code,{children:'"3s"'}),"."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"purge_ip_list"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Array of Strings"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"No"}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:["An IP whitelist. Only ",(0,s.jsx)(t.code,{children:"PURGE"})," requests from these IPs are allowed to clear the cache."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.code,{children:"skip"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"String"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"No"}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:["A regular expression to match against the request URI. Any request that matches will ",(0,s.jsx)(t.strong,{children:"bypass"})," the caching logic."]})]})]})]}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"directory"})," parameter supports two formats:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"memory"}),": Memory cache, using memory as the cache backend. It supports an LRU eviction mechanism and is the default if not configured. The format is ",(0,s.jsx)(t.code,{children:"memory://?max_size=100MB"}),". If ",(0,s.jsx)(t.code,{children:"max_size"})," is not specified, it defaults to ",(0,s.jsx)(t.code,{children:"256MB"}),". If set to ",(0,s.jsx)(t.code,{children:"max_size=10"}),", it will initialize the memory cache using ",(0,s.jsx)(t.code,{children:"10%"})," of available memory."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.code,{children:"file"}),": File cache, using files as the cache backend. It supports an LRU eviction mechanism and is the default if a path is provided. The format is ",(0,s.jsx)(t.code,{children:"/var/cache/pingap/articles?levels=1:2&inactive=7d&reading_max=1000&writing_max=500&cache_max=100&cache_file_max_size=1MB"}),". The parameters are as follows:"]}),"\n"]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Parameter"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Type"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Default"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Description"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"levels"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"String"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"0"}),(0,s.jsxs)(t.td,{style:{textAlign:"left"},children:["Sets the subdirectory levels for the cache, default is not set. This distributes cache files across multiple subdirectory levels to avoid performance degradation from too many files in a single directory. For high-traffic caches, it is strongly recommended to set this to ",(0,s.jsx)(t.code,{children:"1:2"}),"."]})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"inactive"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"String"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:'"48h"'}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:'Inactive file cleanup threshold. If a cache file is not accessed within this time, it is considered inactive and may be cleaned up. The format is a time string, e.g., "7d" (7 days), "24h" (24 hours).'})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"reading_max"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Integer"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"1000"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The maximum number of concurrent reads allowed for cache files."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"writing_max"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Integer"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"1000"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The maximum number of concurrent writes allowed for cache files."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"cache_max"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Integer"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"0"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The maximum number of files that can be held in the in-memory hot cache. This is a second-level cache (tinyLFU) in memory used for storing the most popular small files for extreme read performance."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"cache_file_max_size"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Integer (Bytes)"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"1MB"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"The maximum size of a single file allowed to enter the in-memory hot cache. Files larger than this will only be stored on disk and will not enter the memory hot cache."})]})]})]}),"\n",(0,s.jsx)(t.h2,{id:"complete-example",children:"Complete Example"}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"Goal"}),": Enable caching for read-only APIs under the ",(0,s.jsx)(t.code,{children:"/api/articles/"})," path."]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Use a dual-layer memory and file cache."}),"\n",(0,s.jsxs)(t.li,{children:["Store different cache versions based on whether the client supports ",(0,s.jsx)(t.code,{children:"gzip"})," compression."]}),"\n",(0,s.jsx)(t.li,{children:"Enable cache eviction and cache stampede protection."}),"\n",(0,s.jsx)(t.li,{children:"Only allow internal IPs to clear the cache."}),"\n"]}),"\n",(0,s.jsxs)(t.h4,{id:"1-configure-the-plugin-plugincache-articlestoml",children:["1. Configure the plugin (",(0,s.jsx)(t.code,{children:"plugin.cache-articles.toml"}),")"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-toml",children:'# Enable cache eviction\neviction = true\n# Set memory cache limit to 256MB\nmax_size = "256MB"\n# Store file cache in the specified directory\ndirectory = "/var/cache/pingap/articles"\n\n# Add the Accept-Encoding request header to the cache key to differentiate gzip and non-gzip caches\nheaders = [\n  "Accept-Encoding",\n]\n\n# Enable cache stampede protection with a 2-second lock wait time\nlock = "2s"\n\n# Force cache to expire after a maximum of 1 hour\nmax_ttl = "1h"\n\n# Limit caching to files no larger than 1MB\nmax_file_size = "1MB"\n\n# Only allow requests from the internal network to clear the cache\npurge_ip_list = [\n  "127.0.0.1",\n  "10.0.0.0/8",\n]\n'})})]})}function o(e={}){const{wrapper:t}={...(0,l.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},8453:(e,t,i)=>{i.d(t,{R:()=>c,x:()=>r});var n=i(6540);const s={},l=n.createContext(s);function c(e){const t=n.useContext(l);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),n.createElement(l.Provider,{value:t},e.children)}}}]);