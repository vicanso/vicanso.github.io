"use strict";(self.webpackChunkpingap=self.webpackChunkpingap||[]).push([[7390],{3972:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>n,toc:()=>a});const n=JSON.parse('{"id":"plugins/traffic-splitting","title":"Traffic Splitting","description":"Dynamically route traffic to different upstream services based on a specified percentage. A powerful tool for implementing A/B testing, gradual rollouts, and canary releases, with support for cookie-based session persistence.","source":"@site/docs/plugins/traffic-splitting.md","sourceDirName":"plugins","slug":"/plugins/traffic-splitting","permalink":"/pingap-en/docs/plugins/traffic-splitting","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/plugins/traffic-splitting.md","tags":[],"version":"current","sidebarPosition":99,"frontMatter":{"sidebar_position":99,"title":"Traffic Splitting","description":"Dynamically route traffic to different upstream services based on a specified percentage. A powerful tool for implementing A/B testing, gradual rollouts, and canary releases, with support for cookie-based session persistence."},"sidebar":"tutorialSidebar","previous":{"title":"Content Substitution (Sub Filter)","permalink":"/pingap-en/docs/plugins/sub-filter"},"next":{"title":"User-Agent Restriction","permalink":"/pingap-en/docs/plugins/ua-restriction"}}');var i=s(4848),r=s(8453);const l={sidebar_position:99,title:"Traffic Splitting",description:"Dynamically route traffic to different upstream services based on a specified percentage. A powerful tool for implementing A/B testing, gradual rollouts, and canary releases, with support for cookie-based session persistence."},o="Traffic Splitting Plugin",c={},a=[{value:"Feature Overview",id:"feature-overview",level:2},{value:"Use Cases",id:"use-cases",level:2},{value:"Configuration Parameters",id:"configuration-parameters",level:2},{value:"Complete Example",id:"complete-example",level:2},{value:"Example 1: Canary Release",id:"example-1-canary-release",level:3},{value:"How It Works",id:"how-it-works",level:3},{value:"Example 2: User ID-Based A/B Testing",id:"example-2-user-id-based-ab-testing",level:3},{value:"How It Works",id:"how-it-works-1",level:3}];function d(e){const t={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"traffic-splitting-plugin",children:"Traffic Splitting Plugin"})}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"traffic-splitting"})," plugin is a powerful request routing plugin that allows you to ",(0,i.jsx)(t.strong,{children:"dynamically switch"})," a portion of traffic from a ",(0,i.jsx)(t.code,{children:"Location"}),"'s main upstream service to another specified upstream."]}),"\n",(0,i.jsx)(t.h2,{id:"feature-overview",children:"Feature Overview"}),"\n",(0,i.jsxs)(t.p,{children:["This plugin intervenes at the request phase and decides which upstream service the current request should be sent to based on a configured ",(0,i.jsx)(t.strong,{children:"weight"})," (percentage)."]}),"\n",(0,i.jsxs)(t.p,{children:["For example, you can configure it to send ",(0,i.jsx)(t.strong,{children:"10%"})," of traffic to a new ",(0,i.jsx)(t.code,{children:"v2"})," version of a service, while the remaining ",(0,i.jsx)(t.strong,{children:"90%"})," of traffic continues to be handled by the main upstream service configured in the ",(0,i.jsx)(t.code,{children:"Location"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["Additionally, it supports a ",(0,i.jsx)(t.strong,{children:"Session Persistence (Stickiness)"})," feature. When enabled, the plugin uses a specified cookie to ensure that the same user is always routed to the same upstream service. This is crucial for A/B tests that require a consistent user experience or session state."]}),"\n",(0,i.jsx)(t.h2,{id:"use-cases",children:"Use Cases"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Canary Release"}),":\nWhen you release a new version of an application, you can use this plugin to first direct a small portion of traffic (e.g., 1% or 5%) to the new version. By monitoring the performance and error rates of the new version, you can safely verify its stability before gradually increasing the traffic percentage and eventually completing a full rollout."]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"A/B Testing"}),':\nIf you want to test a new feature or UI design, you can configure the plugin to route a portion of users (e.g., 50%) to the "experimental group" service that includes the new feature, while the other users continue to access the "control group" service. By enabling session persistence, you can ensure that users do not switch back and forth between the two versions during the test period.']}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Feature Flagging"}),":\nFor new features that are being rolled out gradually by region or user, this plugin can be used to direct specific user traffic (via ",(0,i.jsx)(t.code,{children:"stickiness"})," and a specific cookie) to the backend service that has the new feature implemented."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"configuration-parameters",children:"Configuration Parameters"}),"\n",(0,i.jsxs)(t.p,{children:["Configuration is done in the ",(0,i.jsx)(t.code,{children:"plugin.traffic-splitting.toml"})," file."]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Parameter"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Type"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Required"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Default"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Description"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"upstream"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"String"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"Yes"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"-"}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,i.jsx)(t.strong,{children:"(Required)"})," The name of the ",(0,i.jsx)(t.strong,{children:"target upstream service"}),". When a traffic split hits, the request will be routed to this Upstream."]})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"weight"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Integer"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.strong,{children:"Yes"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"-"}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,i.jsx)(t.strong,{children:"(Required)"})," The ",(0,i.jsx)(t.strong,{children:"percentage"})," of traffic to be split to the target ",(0,i.jsx)(t.code,{children:"upstream"}),". The value range is ",(0,i.jsx)(t.code,{children:"0"})," - ",(0,i.jsx)(t.code,{children:"100"}),"."]})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"stickiness"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Boolean"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"No"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"false"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["Whether to enable ",(0,i.jsx)(t.strong,{children:"session persistence"}),". If ",(0,i.jsx)(t.code,{children:"true"}),", the ",(0,i.jsx)(t.code,{children:"sticky_cookie"})," parameter must be configured."]})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"sticky_cookie"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"String"}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,i.jsx)(t.strong,{children:"Yes"}),", if ",(0,i.jsx)(t.code,{children:"stickiness"})," is ",(0,i.jsx)(t.code,{children:"true"})]}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"-"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"The name of the cookie to use for session persistence. The plugin will use the value of this cookie to determine the traffic route, ensuring the same user always visits the same upstream."})]})]})]}),"\n",(0,i.jsx)(t.hr,{}),"\n",(0,i.jsx)(t.h2,{id:"complete-example",children:"Complete Example"}),"\n",(0,i.jsx)(t.h3,{id:"example-1-canary-release",children:"Example 1: Canary Release"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Goal"}),": We have a new service version, ",(0,i.jsx)(t.code,{children:"api-v2"}),", and we want to split ",(0,i.jsx)(t.strong,{children:"5%"})," of the traffic to it for observation, while the remaining 95% continues to use the stable ",(0,i.jsx)(t.code,{children:"api-v1"}),"."]}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsxs)(t.strong,{children:["Configure the Plugin (",(0,i.jsx)(t.code,{children:"plugin.canary-v2.toml"}),")"]}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-toml",children:'# The target upstream is our new version service\nupstream = "api-v2"\n\n# Split 5% of the traffic to api-v2\nweight = 5\n'})}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsxs)(t.strong,{children:["Apply the Plugin in a Location (",(0,i.jsx)(t.code,{children:"location.toml"}),")"]}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-toml",children:'# location.toml\n[[server.locations]]\npath = "/api/users/"\n# The main upstream is still the stable v1 version\nupstream = "api-v1"\nplugins = [\n    "canary-v2",\n]\n'})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"how-it-works",children:"How It Works"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Approximately 95% of requests will be sent normally to the ",(0,i.jsx)(t.code,{children:"Location"}),"'s main upstream, ",(0,i.jsx)(t.code,{children:"api-v1"}),"."]}),"\n",(0,i.jsxs)(t.li,{children:["Approximately 5% of requests will be intercepted by the plugin, and their target upstream will be changed to ",(0,i.jsx)(t.code,{children:"api-v2"}),"."]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"example-2-user-id-based-ab-testing",children:"Example 2: User ID-Based A/B Testing"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:"Goal"}),": We want to test a new feature on 50% of our users. The new feature is deployed on ",(0,i.jsx)(t.code,{children:"recommend-service-v2"}),", and the old feature is on ",(0,i.jsx)(t.code,{children:"recommend-service-v1"}),". We will use the ",(0,i.jsx)(t.code,{children:"user_id"})," cookie to identify users and ensure their experience is consistent."]}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsxs)(t.strong,{children:["Configure the Plugin (",(0,i.jsx)(t.code,{children:"plugin.ab-test-recommend.toml"}),")"]}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-toml",children:'# Target upstream for the experimental group\nupstream = "recommend-service-v2"\n\n# 50% of the traffic goes to the experimental group\nweight = 50\n\n# Enable session persistence\nstickiness = true\n\n# Use the "user_id" cookie to determine the group\nsticky_cookie = "user_id"\n'})}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["\n",(0,i.jsxs)(t.p,{children:[(0,i.jsxs)(t.strong,{children:["Apply the Plugin in a Location (",(0,i.jsx)(t.code,{children:"location.toml"}),")"]}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-toml",children:'# location.toml\n[[server.locations]]\npath = "/api/recommend/"\n# Control group (main upstream)\nupstream = "recommend-service-v1"\nplugins = [\n    "ab-test-recommend",\n]\n'})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"how-it-works-1",children:"How It Works"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["When a ",(0,i.jsx)(t.strong,{children:"new user"})," (without a ",(0,i.jsx)(t.code,{children:"user_id"})," cookie) visits for the first time, the plugin will randomly route them based on the 50% ",(0,i.jsx)(t.code,{children:"weight"}),"."]}),"\n",(0,i.jsxs)(t.li,{children:["When a ",(0,i.jsx)(t.strong,{children:"returning user"})," (with a ",(0,i.jsx)(t.code,{children:"user_id=abc"})," cookie) visits, the plugin will calculate a hash based on the value ",(0,i.jsx)(t.code,{children:"abc"}),".","\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["If the hash result falls within the 50% range, ",(0,i.jsx)(t.strong,{children:"all subsequent requests"})," from this user will be consistently routed to ",(0,i.jsx)(t.code,{children:"recommend-service-v2"}),"."]}),"\n",(0,i.jsxs)(t.li,{children:["If the hash result falls outside the range, ",(0,i.jsx)(t.strong,{children:"all subsequent requests"})," from this user will be consistently routed to ",(0,i.jsx)(t.code,{children:"recommend-service-v1"}),"."]}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,t,s)=>{s.d(t,{R:()=>l,x:()=>o});var n=s(6540);const i={},r=n.createContext(i);function l(e){const t=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),n.createElement(r.Provider,{value:t},e.children)}}}]);